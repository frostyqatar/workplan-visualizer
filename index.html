<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workplan Visualizer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="header">
    <h1>Workplan Visualizer</h1>
    <div class="header-actions">
      <div class="density-toggle">
        <button class="view-btn small" id="densityCompactBtn" title="Compact density">Compact</button>
        <button class="view-btn small active" id="densityComfortBtn" title="Comfortable density">Comfort</button>
      </div>
      <button id="themeToggleBtn" class="btn-secondary" title="Toggle dark mode" aria-label="Toggle dark mode">üåô Dark</button>
      <button class="btn-secondary" title="User guide" aria-label="Open user guide">üìñ Guide</button>
      <button class="btn-secondary" title="Help and shortcuts">‚ùî Help</button>
      <button class="btn-secondary" title="Pick or change NDJSON save location">üíæ Save Location</button>
      <span id="autosaveStatus" class="autosave-status" title="File System Access autosave status">Autosave: Off</span>
    </div>
  </div>

  <div class="input-section">
    <div class="color-palette-section">
      <label class="palette-label">Color Palette:</label>
      <select id="colorPalette" class="color-selector">
        <option value="mckinsey">McKinsey & Company</option>
        <option value="bcg">Boston Consulting Group</option>
        <option value="bain">Bain & Company</option>
        <option value="deloitte">Deloitte</option>
        <option value="pwc">PwC</option>
        <option value="kpmg">KPMG</option>
        <option value="ey">Ernst & Young</option>
        <option value="accenture">Accenture</option>
        <option value="custom">‚ûï Create Custom Palette</option>
      </select>
      <div class="palette-preview" id="palettePreview" title="Current palette preview"></div>
    </div>

    <div class="input-group">
      <input type="text" id="projectInput" class="input-field"
             placeholder="Type a project (e.g., 'Robin Jan‚ÄìSept; CC tasks Q4 2025; Zaynab Q3 2026')">
      <button class="btn-primary send-btn">Send</button>
      <button class="btn-secondary">Change API Key</button>
    </div>

    <div class="search-group">
      <input type="text" id="filterInput" class="search-input" placeholder="Filter projects by name or description..."/>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
    <div class="loading" id="loading"><span class="spinner" aria-hidden="true"></span> Processing with AI...</div>
  </div>

  <div class="timeline-container">
    <div class="timeline-header">
      <h2>Timeline View</h2>
      <div class="year-navigation">
        <button class="nav-arrow" title="Previous period">‚Üê</button>
        <div class="current-year" id="currentPeriod">2025</div>
        <button class="nav-arrow" title="Next period">‚Üí</button>
      </div>
    </div>

    <div class="timeline-view">
      <div class="view-selector">
        <button class="view-btn active" id="yearBtn">14-Month View</button>
        <button class="view-btn" id="quarterBtn">Quarterly View</button>
      </div>

      <div class="controls-section">
        <button class="btn-secondary">‚àí Node</button>
        <button class="btn-secondary">+ Node</button>
        <button class="btn-secondary">‚àí Text</button>
        <button class="btn-secondary">+ Text</button>
        <button class="btn-secondary">Squeeze</button>
        <button class="btn-secondary">Breeze</button>
        <button class="btn-secondary" id="toggleWrapBtn">Wrap: Off</button>
        <button class="btn-secondary" id="toggleAutosortBtn" title="Toggle automatic stacking of overlapping nodes">Autosort: On</button>
        <button class="btn-secondary" id="toggleTodayBtn">Today: Off</button>
        <button class="btn-secondary">üì• Download PNG</button>
        <button class="btn-secondary">üì§ Export Data</button>
        <button class="btn-secondary">üì• Import Data</button>
        <button class="btn-secondary" title="Reset zoom to full 14-month view">Reset Zoom</button>
        <button class="btn-secondary" style="background:#c62828;">üóëÔ∏è Clear All</button>
      </div>

      <div class="timeline-grid" id="timelineGrid">
        <div class="timeline-months" id="timelineMonths"></div>
        <div class="timeline-content" id="timelineContent">
          <!-- Quarter indicators are now rendered dynamically -->
          <div id="todayLine" class="today-line"></div>
        </div>
      </div>

      <div class="drag-instruction">üí° Drag project bars to change dates | Drag projects in the list to reorder</div>

      <div class="projects-list" id="projectsList"></div>
    </div>
  </div>

  <!-- API Key Modal -->
  <div class="api-key-modal" id="apiKeyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Google Gemini API Key Required</h3>
        <p>Please enter your Google Gemini API key to process natural language project inputs.</p>
      </div>
      <div class="input-group">
        <input type="password" id="apiKeyInput" class="input-field" placeholder="Enter your Gemini API key">
        <button class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="import-modal" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import Project Data</h3>
        <p>Paste your exported JSON data below:</p>
      </div>
      <textarea id="importData" placeholder="Paste JSON data here..."></textarea>
      <div class="modal-buttons">
        <button class="btn-secondary">Cancel</button>
        <button class="btn-primary">Import</button>
      </div>
    </div>
  </div>

  <!-- Custom Color Modal -->
  <div class="custom-color-modal" id="customColorModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Custom Color Palette</h3>
        <p>Choose 4 colors for your custom palette:</p>
      </div>

      <input type="text" id="paletteName" class="color-palette-name" placeholder="Enter palette name (e.g., 'My Company Colors')">

      <div class="color-input-grid">
        <div class="color-input-item">
          <label>Color 1</label>
          <input type="color" id="color1" value="#0E4B91">
        </div>
        <div class="color-input-item">
          <label>Color 2</label>
          <input type="color" id="color2" value="#2D61A3">
        </div>
        <div class="color-input-item">
          <label>Color 3</label>
          <input type="color" id="color3" value="#4C77B5">
        </div>
        <div class="color-input-item">
          <label>Color 4</label>
          <input type="color" id="color4" value="#6B8BC7">
        </div>
      </div>

      <div id="existingCustomPalettes"></div>

      <div class="modal-buttons">
        <button class="btn-secondary">Cancel</button>
        <button class="btn-primary">Save Palette</button>
      </div>
    </div>
  </div>

  <!-- Help & Shortcuts Modal -->
  <div class="help-modal" id="helpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Help & Shortcuts</h3>
        <p>Quick tips to speed up your workflow.</p>
      </div>
      <div>
        <ul class="help-list">
          <li><strong>Drag</strong> project bars to move dates</li>
          <li><strong>Double-click</strong> a bar to rename inline</li>
          <li><strong>Right-click</strong> a bar for actions and color</li>
          <li><strong>Enter</strong> to submit text input</li>
          <li><strong>W</strong>: Toggle wrap &bull; <strong>T</strong>: Toggle Today line</li>
          <li><strong>‚Üê/‚Üí</strong>: Navigate period &bull; <strong>Y</strong>/<strong>Q</strong>: Year/Quarter view</li>
          <li><strong>+</strong>/<strong>-</strong>: Zoom in/out (Year view)</li>
          <li><strong>?</strong>: Open this dialog</li>
        </ul>
      </div>
      <div class="modal-buttons">
        <button class="btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- User Guide Modal (Phase 5) -->
  <div class="guide-modal" id="guideModal">
    <div class="modal-content guide-content">
      <div class="modal-header">
        <h3>üìñ User Guide</h3>
        <p>Everything you need to know about Workplan Visualizer.</p>
      </div>
      <div class="guide-body">

        <section class="guide-section">
          <h4>1. Getting Started</h4>
          <p>Add projects using the input field at the top. You can type natural language descriptions and the app will parse them locally ‚Äî no AI needed for most formats. If local parsing fails and you have a Gemini API key configured, it will fall back to AI.</p>
          <p>You can also add projects manually using the quick-add form below the project list, or import them from a JSON file.</p>
        </section>

        <section class="guide-section">
          <h4>2. Input Format Examples</h4>
          <p>The following formats are parsed locally (no AI required):</p>
          <table class="guide-table">
            <thead>
              <tr><th>Format</th><th>Example</th></tr>
            </thead>
            <tbody>
              <tr><td>Quarter range</td><td><code>Task 1 Q1-Q3</code></td></tr>
              <tr><td>Quarter + year</td><td><code>Task Q1-Q3 2025</code></td></tr>
              <tr><td>Single quarter</td><td><code>Review Q4 2025</code></td></tr>
              <tr><td>Month range</td><td><code>Robin Jan-Sept</code></td></tr>
              <tr><td>Month + year</td><td><code>Robin Jan-Sept 2025</code></td></tr>
              <tr><td>Compact dates</td><td><code>Task 12/12-24/12</code></td></tr>
              <tr><td>Full dates</td><td><code>Task 12/12/2024-24/12/2024</code></td></tr>
              <tr><td>CSV</td><td><code>Task, 2025-01-15, 2025-03-31</code></td></tr>
              <tr><td>Multiple (semicolons)</td><td><code>Task 1 Q1-Q3; Task 2 Jan-Mar</code></td></tr>
            </tbody>
          </table>
        </section>

        <section class="guide-section">
          <h4>3. Timeline Navigation</h4>
          <ul>
            <li><strong>14-Month View</strong>: Shows Nov of previous year through Dec of current year</li>
            <li><strong>Quarterly View</strong>: Focuses on a single quarter</li>
            <li>Use <strong>‚Üê ‚Üí</strong> arrows (or keyboard) to navigate periods</li>
            <li>Use <strong>üîç+ / üîç‚àí</strong> buttons (or + / ‚àí keys) to zoom in/out</li>
            <li><strong>Reset Zoom</strong> returns to the full 14-month view</li>
          </ul>
        </section>

        <section class="guide-section">
          <h4>4. Project Management</h4>
          <ul>
            <li><strong>Drag</strong> project bars on the timeline to change dates</li>
            <li><strong>Double-click</strong> a bar to rename it inline</li>
            <li><strong>Right-click</strong> a bar for actions: edit, color, milestones, duplicate, delete</li>
            <li><strong>Click</strong> project names or dates in the list to edit them</li>
            <li><strong>Drag</strong> projects in the list (via the ‚ãÆ‚ãÆ handle) to reorder them</li>
            <li><strong>Filter</strong> projects using the search box</li>
          </ul>
        </section>

        <section class="guide-section">
          <h4>5. Customization</h4>
          <ul>
            <li><strong>Color Palettes</strong>: Choose from 8 built-in palettes or create custom ones</li>
            <li><strong>+ Node / ‚àí Node</strong>: Adjust bar height</li>
            <li><strong>+ Text / ‚àí Text</strong>: Adjust text size on bars</li>
            <li><strong>Squeeze / Breeze</strong>: Adjust spacing between rows</li>
            <li><strong>Wrap</strong>: Toggle text wrapping on bars</li>
            <li><strong>Autosort</strong>: Automatically stack overlapping bars</li>
            <li><strong>Today</strong>: Show/hide the current date indicator</li>
            <li><strong>Compact / Comfort</strong>: Toggle density mode</li>
            <li><strong>Dark / Light</strong>: Toggle theme</li>
          </ul>
        </section>

        <section class="guide-section">
          <h4>6. Keyboard Shortcuts</h4>
          <table class="guide-table">
            <tbody>
              <tr><td><kbd>W</kbd></td><td>Toggle wrap</td></tr>
              <tr><td><kbd>T</kbd></td><td>Toggle Today line</td></tr>
              <tr><td><kbd>Y</kbd></td><td>Year view</td></tr>
              <tr><td><kbd>Q</kbd></td><td>Quarter view</td></tr>
              <tr><td><kbd>‚Üê ‚Üí</kbd></td><td>Navigate period</td></tr>
              <tr><td><kbd>+ ‚àí</kbd></td><td>Zoom in / out</td></tr>
              <tr><td><kbd>?</kbd></td><td>Open help</td></tr>
              <tr><td><kbd>Enter</kbd></td><td>Submit input</td></tr>
            </tbody>
          </table>
        </section>

        <section class="guide-section">
          <h4>7. Data Management</h4>
          <ul>
            <li><strong>üì§ Export Data</strong>: Download all projects as JSON</li>
            <li><strong>üì• Import Data</strong>: Load projects from a JSON file or pasted text</li>
            <li><strong>üì• Download PNG</strong>: Save the timeline as an image</li>
            <li>Projects are automatically saved to your browser's localStorage</li>
          </ul>
        </section>

      </div>
      <div class="modal-buttons">
        <button class="btn-primary" data-action="close-guide">Close</button>
      </div>
    </div>
  </div>

  <!-- Context menu -->
  <div id="nodeContextMenu" class="context-menu hidden"></div>

  <input type="file" id="fileInput" class="file-input" accept=".json">

  <script type="module" src="app.js"></script>
</body>
</html>
